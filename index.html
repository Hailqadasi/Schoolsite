<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¬Ù…Ù„ ØµÙˆØ±Ø©</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:tahoma;background:#f5f5f5;margin:0;padding:10px}
h2{text-align:center}
.card{background:#fff;padding:10px;margin:10px 0;border-radius:6px}
img{max-width:100%;border-radius:6px}
button{padding:8px 15px;margin-top:5px}
.ad{background:#ffeeba;padding:15px;text-align:center;margin:15px 0}
.best{border:3px solid gold}
</style>
</head>

<body>

<h2>ğŸ“¸ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¬Ù…Ù„ ØµÙˆØ±Ø©</h2>

<input type="file" accept="image/*" capture="environment" id="img">
<button onclick="upload()">ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©</button>

<div id="bestImage"></div>
<div id="photos"></div>

<script>
// ğŸ”¹ Ø±Ø¨Ø· Supabase
const supabase = supabase.createClient(
  "https://hzuogtisbufdjmphgzic.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6dW9ndGlzYnVmZGptcGhnemljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTI5MTgsImV4cCI6MjA4NjIyODkxOH0.m4EYcTVIvuuxoTLIFLBuVVNdj6Fx2Af-KBv30EHIkOQ"
);

// Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¤Ù‚Øª
const username = "user_" + Math.floor(Math.random()*10000);

// Ø±ÙØ¹ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø§Ù„ÙŠÙˆÙ…
async function upload(){
    const file = img.files[0];
    if(!file) return alert("Ø§Ø®ØªØ± ØµÙˆØ±Ø©");

    const today = new Date().toISOString().slice(0,10);

    // ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙˆØ±Ø© Ø§Ù„ÙŠÙˆÙ…
    const { data:existing } = await supabase
      .from("photos")
      .select("*")
      .eq("username", username)
      .eq("created_at", today);

    if(existing.length>0){
        return alert("âŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø§Ù„ÙŠÙˆÙ…");
    }

    const path = `${Date.now()}_${file.name}`;
    await supabase.storage.from("photos").upload(path, file);

    const url = supabase.storage.from("photos").getPublicUrl(path).data.publicUrl;

    await supabase.from("photos").insert({
        username,
        image_url: url,
        created_at: today
    });

    alert("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
    loadPhotos();
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± ÙˆØ¹Ø±Ø¶ Ø£Ø¬Ù…Ù„ ØµÙˆØ±Ø©
async function loadPhotos(){
    const { data } = await supabase
      .from("photos")
      .select("*")
      .order("votes",{ascending:false});

    const photosDiv = document.getElementById("photos");
    const bestDiv = document.getElementById("bestImage");

    if(!data || data.length===0){
        photosDiv.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ø¨Ø¹Ø¯";
        bestDiv.innerHTML = "";
        return;
    }

    // Ø£Ø¬Ù…Ù„ ØµÙˆØ±Ø©
    const best = data[0];
    bestDiv.innerHTML = `
      <h3>ğŸ† Ø£Ø¬Ù…Ù„ ØµÙˆØ±Ø©</h3>
      <div class="card best">
        <img src="${best.image_url}">
        <p>â­ ${best.votes} ØªØµÙˆÙŠØª</p>
      </div>
    `;

    let html = "";
    data.forEach((p,i)=>{
        if(i>0 && i%2===0){
            html += `<div class="ad">ğŸ“¢ Ø¥Ø¹Ù„Ø§Ù†Ùƒ Ù‡Ù†Ø§</div>`;
        }

        html += `
        <div class="card">
          <img src="${p.image_url}">
          <p>â¤ï¸ ${p.votes}</p>
          <button onclick="vote('${p.id}')">ØªØµÙˆÙŠØª</button>
        </div>
        `;
    });

    photosDiv.innerHTML = html;
}

// ØªØµÙˆÙŠØª
async function vote(id){
    await supabase.rpc("increment_vote",{photo_id:id});
    loadPhotos();
}

// ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadPhotos();
</script>

</body>
</html>
