 <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:tahoma;text-align:center;background:#f5f5f5;margin:0;padding:0}
.box{margin:50px auto;width:90%;max-width:350px;background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.1)}
input,button{width:100%;padding:12px;margin-top:10px;font-size:16px;border-radius:5px}
input{border:1px solid #ccc}
button{background:#28a745;color:#fff;border:0;cursor:pointer}
button:hover{background:#218838}
#acSection{display:none}
#timeLeft{color:#555;font-size:14px;margin-top:15px;background:#f9f9f9;padding:8px;border-radius:4px;direction:ltr}
#msg{margin-top:15px;font-weight:bold;color:#333}
</style>
</head>

<body>

<div class="box" id="activationBox">
  <h3>Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„</h3>
  <input id="code" placeholder="ÙƒÙˆØ¯ Ø§Ù„ÙƒØ±Øª">
  <button id="activateBtn">ØªÙØ¹ÙŠÙ„</button>
  <p id="msg"></p>
</div>

<div class="box" id="acSection">
  <h3>Ù‚Ø³Ù… AC</h3>
  <p>âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­</p>
  <div id="timeLeft"></div>
  <button id="goAcBtn">Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
</div>

<script>
window.onload = async function(){

  const { createClient } = supabase;

  const client = createClient(
    "https://lhzyuezkfnsdkufvatzu.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxoenl1ZXprZm5zZGt1ZnZhdHp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNDYzOTYsImV4cCI6MjA4MTgyMjM5Nn0.1Bdzz52Abm3PSlnzOWlSKS2RVMqgkiOekA38abGScKA"
  );

  const activationBox = document.getElementById("activationBox");
  const acSection = document.getElementById("acSection");
  const activateBtn = document.getElementById("activateBtn");
  const goAcBtn = document.getElementById("goAcBtn");
  const msg = document.getElementById("msg");
  const timeLeft = document.getElementById("timeLeft");

  const MAX_TIME = 1 * 60 * 60 * 1000; // 1 Ø³Ø§Ø¹Ø©
  let sessionStart = Date.now();
  let timer;

  // ğŸ” Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²
  const saved = JSON.parse(localStorage.getItem("activation_data"));
  if(saved && saved.usedTime < MAX_TIME){
    openAc();
    sessionStart = Date.now();
    startTimer();
  } else if(saved && saved.usedTime >= MAX_TIME){
    msg.innerHTML = "â›” Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ±Øª";
  }

  // ğŸ”˜ Ø²Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„
  activateBtn.onclick = async () => {
    msg.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
    const code = document.getElementById("code").value.trim().toUpperCase();

    if(!code){
      msg.innerHTML = "âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ÙƒØ±Øª";
      return;
    }

    // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙƒØ±Øª
    const { data: card, error: selectError } = await client
      .from("cards")
      .select("*")
      .eq("code", code)
      .limit(1)
      .single();

    if(selectError || !card){
      msg.innerHTML = "âŒ Ø§Ù„ÙƒØ±Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
      return;
    }

    if(card.used === true){
      msg.innerHTML = "âŒ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„ÙƒØ±Øª Ù…Ø³Ø¨Ù‚Ù‹Ø§";
      return;
    }

    // ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ±Øª Ø¥Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…
    const { error: updateError } = await client
      .from("cards")
      .update({ used: true })
      .eq("id", card.id);

    if(updateError){
      msg.innerHTML = "âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ±Øª (ØªØ­Ù‚Ù‚ Ù…Ù† RLS)";
      return;
    }

    // ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²
    localStorage.setItem("activation_data", JSON.stringify({
      usedTime: 0,
      code: code
    }));

    openAc();
    sessionStart = Date.now();
    startTimer();
  };

  // â± ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯
  function startTimer(){
    clearInterval(timer);
    timer = setInterval(()=>{
      const data = JSON.parse(localStorage.getItem("activation_data"));
      if(!data) return;

      const used = data.usedTime + (Date.now() - sessionStart);
      const remaining = MAX_TIME - used;

      if(remaining <= 0){
        endActivation();
        return;
      }

      const h = Math.floor(remaining / 3600000);
      const m = Math.floor((remaining % 3600000) / 60000);
      const s = Math.floor((remaining % 60000) / 1000);

      timeLeft.innerHTML = `â³ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${h} Ø³ ${m} Ø¯ ${s} Ø«`;
    },1000);
  }

  // â›” Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªÙØ¹ÙŠÙ„
  function endActivation(){
    clearInterval(timer);
    localStorage.removeItem("activation_data");
    activationBox.style.display="block";
    acSection.style.display="none";
    msg.innerHTML = "â›” Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ±Øª";
    timeLeft.innerHTML = "";
  }

  // ğŸ‘ï¸ ÙØªØ­ Ù‚Ø³Ù… AC
  function openAc(){
    activationBox.style.display="none";
    acSection.style.display="block";
    msg.innerHTML = "";
  }

  // ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙˆÙ‚Øª Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  window.addEventListener("beforeunload", ()=>{
    const data = JSON.parse(localStorage.getItem("activation_data"));
    if(!data) return;
    data.usedTime += Date.now() - sessionStart;
    localStorage.setItem("activation_data", JSON.stringify(data));
  });

  // Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
  goAcBtn.onclick = ()=> location.href="https://your-site-link.com";
};
</script>

</body>
</html>
