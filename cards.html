 <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>تفعيل التطبيق</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{font-family:tahoma;text-align:center;background:#f5f5f5}
.box{margin:50px auto;width:300px;background:#fff;padding:20px;border-radius:8px}
input,button{width:100%;padding:10px;margin-top:10px}
button{background:#28a745;color:#fff;border:0;cursor:pointer}
#acSection{display:none}
#timeLeft{color:#555;font-size:14px;margin-top:15px;background:#f9f9f9;padding:8px;border-radius:4px;direction:ltr}
</style>
</head>

<body>

<div class="box" id="activationBox">
  <h3>أدخل كود التفعيل</h3>
  <input id="code" placeholder="كود الكرت">
  <button id="activateBtn">تفعيل</button>
  <p id="msg"></p>
</div>

<div class="box" id="acSection">
  <h3>قسم AC</h3>
  <p>✅ تم تفعيل التطبيق</p>
  <div id="timeLeft"></div>
  <button id="goAcBtn">الدخول</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", async function(){

  const client = supabase.createClient(
    "https://pbkwfmhanvffapheqepl.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBia3dmbWhhbnZmZmFwaGVxZXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5OTAyMzUsImV4cCI6MjA4MzU2NjIzNX0.jwgrX2jYQvf2SWNW-vYd0GGdNI_8QwUsq-Ks8_hMouE"
  );

  const activationBox = document.getElementById("activationBox");
  const acSection = document.getElementById("acSection");
  const activateBtn = document.getElementById("activateBtn");
  const goAcBtn = document.getElementById("goAcBtn");
  const msg = document.getElementById("msg");
  const timeLeft = document.getElementById("timeLeft");

  const MAX_TIME = 1 * 60 * 60 * 1000; // ساعة واحدة
  let sessionStart = Date.now();
  let timer;

  // استرجاع التفعيل من الجهاز
  const saved = JSON.parse(localStorage.getItem("activation_data"));
  if(saved && saved.usedTime < MAX_TIME){
    openAc();
    sessionStart = Date.now();
    startTimer();
  } else if(saved && saved.usedTime >= MAX_TIME){
    msg.innerHTML = "⛔ انتهت صلاحية الكرت";
  }

  // زر التفعيل
  activateBtn.onclick = async () => {

    msg.innerHTML = "⏳ جاري التحقق...";
    const code = document.getElementById("code").value.trim().toUpperCase();

    if(!code){
      msg.innerHTML = "❌ أدخل كود الكرت";
      return;
    }

    const { data: card, error: selectError } = await client
      .from("cards")
      .select("*")
      .eq("code", code)
      .limit(1)
      .single();

    if(selectError || !card){
      msg.innerHTML = "❌ الكرت غير موجود";
      return;
    }

    if(card.used === true){
      msg.innerHTML = "❌ الكرت مستخدم مسبقًا";
      return;
    }

    const { error: updateError } = await client
      .from("cards")
      .update({ used: true })
      .eq("id", card.id);

    if(updateError){
      msg.innerHTML = "❌ لا يمكن تفعيل الكرت (تحقق من RLS)";
      return;
    }

    localStorage.setItem("activation_data", JSON.stringify({
      usedTime: 0,
      code: code
    }));

    openAc();
    sessionStart = Date.now();
    startTimer();
  };

  function startTimer(){
    clearInterval(timer);
    timer = setInterval(()=>{
      const data = JSON.parse(localStorage.getItem("activation_data"));
      if(!data) return;

      const used = data.usedTime + (Date.now() - sessionStart);
      const remaining = MAX_TIME - used;

      if(remaining <= 0){
        endActivation();
        return;
      }

      const h = Math.floor(remaining / 3600000);
      const m = Math.floor((remaining % 3600000) / 60000);
      const s = Math.floor((remaining % 60000) / 1000);

      timeLeft.innerHTML = `⏳ المتبقي: ${h} س ${m} د ${s} ث`;
    },1000);
  }

  function endActivation(){
    clearInterval(timer);
    localStorage.removeItem("activation_data");
    activationBox.style.display="block";
    acSection.style.display="none";
    msg.innerHTML = "⛔ انتهت صلاحية الكرت";
    timeLeft.innerHTML = "";
  }

  function openAc(){
    activationBox.style.display="none";
    acSection.style.display="block";
    msg.innerHTML = "";
  }

  window.addEventListener("beforeunload", ()=>{
    const data = JSON.parse(localStorage.getItem("activation_data"));
    if(!data) return;
    data.usedTime += Date.now() - sessionStart;
    localStorage.setItem("activation_data", JSON.stringify(data));
  });

  goAcBtn.onclick = () => {
    window.location.href = "game.html";
  };

});
</script>

</body>
</html>
